version: "3.9"

services:
  redis-service:
    image: public.ecr.aws/docker/library/redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - taskmanager-net

  nats:
    image: public.ecr.aws/docker/library/nats:2.10.10
    command: ["-c", "/etc/nats/nats.conf"]
    restart: unless-stopped
    volumes:
      - ../../configs/nats.conf:/etc/nats/nats.conf:ro
      - nats-data:/data
    ports:
      - "4222:4222"
      - "8222:8222"
    networks:
      - taskmanager-net

  envoy:
    image: envoyproxy/envoy:v1.30.2
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    restart: unless-stopped
    volumes:
      - ../../configs/envoy.yaml:/etc/envoy/envoy.yaml:ro
    ports:
      - "50051:50051"
      - "9901:9901"
    depends_on:
      - taskmanager-service
    networks:
      - taskmanager-net

  taskmanager-service:
    build:
      context: ../../
      dockerfile: server/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - notifier
      - redis-service
    networks:
      - taskmanager-net

  ingest:
    build:
      context: ../../
      dockerfile: ingest/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - ENRICHER_URL=http://enricher:8080/enrich
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - redis-service
      - enricher
    networks:
      - taskmanager-net

  enricher:
    build:
      context: ../../
      dockerfile: enricher/Dockerfile
    restart: unless-stopped
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    networks:
      - taskmanager-net

  scheduler:
    build:
      context: ../../
      dockerfile: scheduler/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - redis-service
    networks:
      - taskmanager-net

  worker:
    build:
      context: ../../
      dockerfile: worker/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - WORKER_COUNT=4
      - WORKER_FAIL_RATE=0.05
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - redis-service
    networks:
      - taskmanager-net

  notifier:
    build:
      context: ../../
      dockerfile: notifier/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - redis-service
    networks:
      - taskmanager-net

  result-store:
    build:
      context: ../../
      dockerfile: result-store/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - RESULT_STORE_PORT=8082
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    ports:
      - "8082:8082"
    depends_on:
      - redis-service
    networks:
      - taskmanager-net

  audit:
    build:
      context: ../../
      dockerfile: audit/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - redis-service
    networks:
      - taskmanager-net

  deadletter:
    build:
      context: ../../
      dockerfile: deadletter/Dockerfile
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis-service:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
    depends_on:
      - redis-service
    networks:
      - taskmanager-net

  e2e-tests:
    build:
      context: ../../
      dockerfile: tests/e2e/Dockerfile
    environment:
      - TASKMANAGER_ADDR=envoy:50051
    depends_on:
      - envoy
    networks:
      - taskmanager-net

networks:
  taskmanager-net:
    name: taskmanager-net
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  redis-data:
  nats-data:
